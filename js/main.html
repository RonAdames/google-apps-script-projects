<script>
    const RE_EMAIL = /^[a-z][a-z0-1\._-]{2,}@[a-z0-1\._-]{2,}[a-z]$/i
    
    // Initialize Vue Material
    Vue.use(VueMaterial.default)
    
    const methods = {
        checkEvents: function(day){
            if (this.selectedDate !== day.value){
                this.selectedTime = null
                this.submitting = true
                this.selectedDate = day.value
                this.events = []                
                google.script.run
                  .withSuccessHandler(events=>{
                      events = JSON.parse(events)
                      if (events.length) this.events = events
                      this.submitting = false
                  })
                  .getEvents(this.selectedDate, this.workingHours,  this.meetingTime, this.userTimeZone)
            }
        },
        addNewMeeting: function(event){
            this.form.valid = null
            this.form.email.value = null
            this.form.email.valid = null
            this.form.name.value = null
            this.form.name.valid = null
            this.form.guests.value = []
            this.form.guests.valid = null
            this.form.content.value = null
            this.form.content.valid = null
            
            this.selectedTime = event.startDate
            this.form.event = event
            this.form.active = true
            
            this.form.callback = ()=>{
                const data = {
                    event,
                    name: this.form.name.value,
                    email: this.form.email.value,
                    content: this.form.content.value,
                    guests: this.form.guests.value.join(","),
                }
                this.submitting = true
                google.script.run
                    .withSuccessHandler(result=>{
                        this.submitting = false
                        this.form.active = false
                        this.events = []
                        this.selectedDate = null
                        this.selectedTime = null
                       
                        this.alert.active = true
                        this.alert.message = result
                        this.alert.title = result.indexOf("successfully.") !== -1 ? "Success" : "Warning"
                    })
                    .withFailureHandler(error=>{
                        this.submitting = false
                        this.form.active = false
                        this.alert.active = true
                        this.alert.message = error.message
                        this.alert.title = "Error"
                    })
                    .createEvent(JSON.stringify(data))
            }
        },
        validateForm: function(item){
            item.valid = true
            if (item.value === null){
                item.valid = false
                item.error = "This is a required field"
            }else{
                if (item.value === "") {
                    item.valid = false
                    item.error = "This is a required field"
                }else{
                    if ( item.label === "Email" && !RE_EMAIL.test(item.value) ){
                        item.valid = false
                        item.error = "Invalid email address"
                    }
                }
            }
            this.form.valid = this.form.email.valid && 
                this.form.name.valid && 
                this.form.content.valid && 
                this.form.guests.valid !== false
        },
        validateGuests: function(){
            this.form.guests.valid = true
            for (let email of this.form.guests.value){
                if ( !RE_EMAIL.test(email) ) {
                    this.form.guests.valid = false
                    this.form.guests.error = "Invliad email address"
                    break
                }
            }
            this.form.valid = this.form.email.valid && 
                this.form.name.valid && 
                this.form.content.valid && 
                this.form.guests.valid !== false
        },
        toLowerCase: function(value){
            return value.toLowerCase()
        },
    }
    
    const computed = {
        nextDays: function(){
            const now = new Date()
            const days = this.days
            const meetingTime = this.meetingTime
            const [{start}] = this.workingHours
            const startHour = Math.floor(start)
            const startMinute = Math.floor((start - startHour) * 60)
            
            const nextDays = []
            for (let i = 0; i < days; i ++) {
                let nextDay = new Date(now.getTime() + i * 24 * 60 * 60 * 1000)
                
                nextDay.setHours(startHour)
                nextDay.setMinutes(startMinute)
                nextDay.setSeconds(0)
                nextDay.setMilliseconds(0)
                
                let value = nextDay.getTime()
                let day = nextDay.getDate()
                let month = nextDay.getMonth()
                let monthName = this.monthNames[month]
                let year = nextDay.getFullYear()
                let weekday = nextDay.getDay()
                let weekdayName = this.weekdayNames[weekday]
                let localeDateString = nextDay.toLocaleDateString()
                
                nextDays.push({value, day, month, monthName, year, weekday, weekdayName, localeDateString})
            }
            return nextDays
        },
    }
    
    const mounted = function(){
        this.userTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone
//            this.userTimeZone = "Asia/Shanghai"
    }
    
    google.script.run
        .withSuccessHandler(appData=>{
            const data = JSON.parse(appData)
            new Vue({
                el: "#app",
                data,
                methods,
                computed,
                mounted,
            })
        })
        .getAppData()
</script>


