<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,400italic|Material+Icons">
    <link rel="stylesheet" href="https://unpkg.com/vue-material/dist/vue-material.min.css">
    <link rel="stylesheet" href="https://unpkg.com/vue-material/dist/theme/default.css">
    <style>        
        body {
            background: #fff;
        }
        
        [v-cloak] {
            display: block;
            padding: 50px 0;
        }
    
        @keyframes spinner {
            to {
                transform: rotate(360deg);
            }
        }
    
        [v-cloak]:before {
            content: "";
            box-sizing: border-box;
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50px;
            height: 50px;
            margin-top: -25px;
            margin-left: -25px;
            border-radius: 50%;
            border: 5px solid #ccc;
            border-top-color: #448AFF;
            animation: spinner 0.8s linear infinite;
            text-indent: 100%;
            white-space: nowrap;
            overflow: hidden;
        }
    
        [v-cloak]>* {
            display: none;
        }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <div v-if="loadingError">
            <p>{{loadingError}}</p>
        </div>
        
        <div v-else>
            <md-steppers md-vertical>
                <md-step md-label="Validate Form" md-description="Enter the form URL and validate it">
                    <md-field>
                        <label>Form URL</label>
                        <md-input
                            v-model.trim="appSettings.url"
                            placeholder="The form editable URL(not the published URL)"
                            :disabled="submitting"
                        ></md-input>
                    </md-field>
                    <div>
                        <md-button
                            class="md-raised md-primary"
                            :disabled="appSettings.url === '' || appSettings.url === null || submitting"
                            @click="validateForm"
                            >Validate</md-button>
                        <md-button
                            v-if="appSettings.editResponseUrl"
                            class="md-raised md-primary"
                            :disabled="submitting"
                            :href="appSettings.editResponseUrl"
                            target="_blank"
                            >Edit The Frist Response</md-button>
                    </div>
                </md-step>
                
                <md-step v-if="!appSettings.hasFirstResponse"
                    md-label="Create the First Response" 
                    md-description="Create the frist reponse in the form">
                    <div>
                        <p>Click the below button to create the first response</p>
                        <md-button 
                            class="md-raised md-primary"
                            :href="appSettings.publishedUrl"
                            :disabled="submitting"
                            target="_blank">Create</md-button>
                    </div>
                    <div>
                        <p>Click the below button to refresh the data after the submission</p>
                        <md-button 
                            class="md-raised md-accent"
                            @click="validateForm"
                            :disabled="appSettings.url === '' || appSettings.url === null || submitting"
                            target="_blank">Re-validate</md-button>
                    </div>
                </md-step>
                
                <md-step v-else
                    md-label="Create Prefilled Content Temlpate" 
                    md-description="Create a template for prefilled content in the spreadsheet">
                    <div>
                        <p>Create a prefilled content template sheet in current spreadsheet (it can be created manually)</p>
                        <md-button 
                            class="md-raised md-accent" 
                            @click="createTemplate"
                            :disabled="!appSettings.hasFirstResponse || submitting">Create</md-button>
                    </div>
                </md-step>
            </md-steppers>
        </div>
        
        <md-dialog-alert
            :md-active.sync="alert.active"
            :md-title="alert.title"
            :md-content="alert.content" />
    </div>

    <script src="https://unpkg.com/vue"></script>
    <script src="https://unpkg.com/vue-material"></script>
    <script>
        Vue.use(VueMaterial.default)
        const data = {
            submitting: false,
            loadingError: null,
            alert:{
                active: false,
                title: null,
                content: null,
            },
            appSettings: {}
        }
        
        const methods = {
            validateForm: function(){
                this.submitting = true
                google.script.run
                    .withSuccessHandler(appSettings=>{
                        this.submitting = false
                        appSettings = JSON.parse(appSettings)
                        this.appSettings = appSettings
                        console.log(appSettings)
                        if (!appSettings.url) {
                            this.alert = {
                                active: true,
                                title: "Error",
                                content: "Invaid form URL",
                            }
                        }else{
                            if (appSettings.hasFirstResponse){
                                this.alert = {
                                    active: true,
                                    title: "Success",
                                    content: "You can now create the prefilled content template.",
                                }
                            }else{
                                this.alert = {
                                    active: true,
                                    title: "Warning",
                                    content: "There is no response in the form yet, you need to create one at least for the prefilled link template.",
                                }
                            }
                        }
                    })
                    .withFailureHandler(error=>{
                        this.submitting = false
                        let message = error.message
                        if (error.message === "Exception: Invalid argument: url") message = "Invalid form URL, please use a valid form URL."
                        this.alert = {
                            active: true,
                            title: "Error",
                            content: message,
                        }
                    })
                    .validateForm(this.appSettings.url)
            },
            createTemplate: function(){
                this.submitting = true
                google.script.run
                    .withSuccessHandler(message=>{
                        this.submitting = false
                        this.alert = {
                            active: true,
                            title: "Message",
                            content: message,
                        }
                    })
                    .withFailureHandler(error=>{
                        this.submitting = false
                        let message = error.message
                        this.alert = {
                            active: true,
                            title: "Error",
                            content: message,
                        }
                    })
                    .createTemplate()
            }
        }
        
        google.script.run
            .withSuccessHandler(appSettings=>{
                appSettings = JSON.parse(appSettings)
                if (appSettings !== null) data.appSettings = appSettings
                console.log(data)
                const App = new Vue({
                    el: "#app",
                    data,
                    methods,
                })
            })
            .withFailureHandler(error=>{
                data.loadingError = error.message
                const App = new Vue({
                    el: "#app",
                    data,
                    methods,
                })
            })
            .validateForm()
        
    
    </script>
</body>
</html>

