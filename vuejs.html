<script>
	const DATA = {
        snackbar: { show: false, color: null, text: null, timeout: null },
        submitting: false,
        loadingError: null,
        selectedItem: null,
        selectedItems: [],
        links: [
            {
                icon: "mdi-youtube",
                label: "YouTube",
                url: "https://youtube.com/ashtonfei"
            },
            {
                icon: "mdi-twitter",
                label: "Twitter",
                url: "https://twitter.com/ashton_fei"
            },
            {
                icon: "mdi-instagram",
                label: "Instagram",
                url: "https://www.instagram.com/ashton.fei/"
            },
            {
                icon: "mdi-gmail",
                label: "Gmail",
                url: "mailto:yunjia.fei@gmail.com?subject=Google%20Apps%20Script"
            }
        ]
    }
    function addSelectedItem(i) {
        this.selectedItems = [
            ...this.selectedItems.slice(0, i + 1),
            JSON.parse(JSON.stringify(this.selectedItem)),
            ...this.selectedItems.slice(i + 1)
        ]
    }

    function removeSelectedItem(i) {
        this.selectedItems = this.selectedItems.filter((_, index) => index !== i)
    }

    function submit() {
        this.submitting = true
        const items = []
        this.selectedItems.forEach(selectedItem => {
            const item = {}
            this.commonFormItems.forEach(v => item[v.key] = v.value)
            Object.keys(selectedItem).forEach(key => item[key] = selectedItem[key].value)
            items.push(item)
        })
        google.script.run
            .withSuccessHandler(() => {
                this.showSnackbar({ text: "Success", color: "green", timeout: 5000 })
                this.submitting = false
                this.$refs.form.reset()
            })
            .withFailureHandler((e) => {
                this.showSnackbar({ text: e.message, color: "error", timeout: -1 })
                this.submitting = false
            })
            .submit(JSON.stringify(items))
    }

    function showSnackbar({ text, color, timeout }) {
        this.snackbar.text = text
        this.snackbar.color = color
        this.snackbar.timeout = timeout || 5000
        this.snackbar.show = true
    }

    window.onload = () => {
        google.script.run
            .withSuccessHandler((response) => {
                const appData = JSON.parse(response)
                const selectedItem = {}
                appData.repeatFormItems.forEach(item => {
                    selectedItem[item.key] = item
                })
                DATA.selectedItem = JSON.parse(JSON.stringify(selectedItem))
                DATA.selectedItems = [JSON.parse(JSON.stringify(selectedItem))]
                new Vue({
                    el: '#app',
                    data: () => ({
                        ...DATA,
                        ...appData,
                    }),
                    methods: {
                        addSelectedItem,
                        removeSelectedItem,
                        submit,
                        showSnackbar,
                    },
                    computed: {
                        totalQty: function () {
                            let total = 0
                            this.selectedItems.forEach(item => {
                                total += item.qty.value
                            })
                            return total
                        },
                        totalPrice: function () {
                            let total = 0
                            this.selectedItems.forEach(item => {
                                if (item.item.value) {
                                    const price = item.item.items.find(v => v.itemNo == item.item.value).price
                                    total += item.qty.value * price
                                }
                            })
                            return total
                        }
                    },
                    vuetify: new Vuetify(),
                })
            })
            .withFailureHandler((e) => {
                DATA.loadingError = e.message
                new Vue({
                    el: '#app',
                    data: () => ({
                        ...DATA
                    }),
                    vuetify: new Vuetify(),
                })
            })
            .getAppData()
    }
</script>