<script>
const refreshMins = 1

const app = document.getElementById("app")
app.innerHTML = `
<div class="text-muted">
<div class="spinner-grow spinner-grow-sm text-muted" role="status">
</div>
<span>Loading...</span>
</div>
`

load()
setInterval(reload, refreshMins * 60 * 1000)

function reload(){
  document.getElementById("refresh-time").innerHTML = `
  <div class="text-muted">
  <div class="spinner-grow spinner-grow-sm text-muted" role="status">
  </div>
  <span>Refreshing...</span>
  </div>
  `
  load()
}

function load(){
google.script.run
.withSuccessHandler( (data) => {
const { charts, appName } = JSON.parse(data)
createCharts(charts, appName)
})
.withFailureHandler(e => app.innerHTML = `<p class="error">${e.message}</p>`)
.getDashboardData()
}

function createCharts(charts, appName){
  const chartDivs = charts.map(chartData => {
    const chartDiv = document.createElement("DIV")
    chartDiv.className = "col"
    const chartCanvas = document.createElement("CANVAS")
    const ctx = chartCanvas.getContext('2d')
    const chartObj = new Chart(ctx, chartData)
    chartDiv.appendChild(chartCanvas)
    return chartDiv
  })
  
  const rowDiv = document.createElement("DIV")
  rowDiv.className = "row row-cols-1 row-cols-md-2 row-cols-lg-3"
  
  chartDivs.forEach(div => rowDiv.appendChild(div))
  app.innerHTML = ""
  
  const updatedTime = new Date().toLocaleString()
  
  const title = document.createElement("DIV")
  title.className = "row-cols-1"
  title.innerHTML = `<div class="col"><h1 class="text-dark">${appName}</h1></div><div class="col text-muted fs-6" id="refresh-time">Refreshed: ${updatedTime} (refresh every ${refreshMins} mins)</div>`
  
  app.appendChild(title)
  app.appendChild(rowDiv)
}
</script>