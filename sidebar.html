<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
    <style>
        input, textarea, select {
            width: 100%;
        }
        a.button {
            padding: 0px 8px;
            background: #673AB7;
            color: #fff;
        }
    </style>
  </head>
  <body>
    <div class="sidebar">
        <div class="block form-group">
            <label for="title">Choose a text item</label>
            <select id="title" value="<?= title ?>">
                <? for (let textTitle of titles ) { ?>
                    <option value="<?= textTitle ?>"><?= textTitle ?></option>
                <? } ?>
            </select>
        </div>
        <div class="block form-group">
            <label for="description">Description</label>
            <input id="description" type="text" value="<?= description ?>" class="block">
        </div>
        <div class="block form-group">
            <label for="items">Valid items for response validation</label>
            <textarea id="items" class="block" placeholder="One line per item" rows="6"><?= items ?></textarea>
        </div>
        <div class="block form-group">
            <label for="error">Custom error text</label>
            <input id="error" type="text" value="<?= error ?>" class="block">
        </div>
        <div class="block form-group">
            <label for="empty-message">Empty message</label>
            <input id="empty-message" type="text" value="<?= emptyMessage ?>" class="block">
        </div>
        
        <div class="block form-group">
            <button class="action" id="update">Update</button>
            <a class="button" target="_blank" href="<?= url ?>">Submit a response</a>
            <div id="message"></div>
        </div>
    </div>
    
    <script>
        const titleElement = document.querySelector("#title")
        const descriptionElement = document.querySelector("#description")
        const itemsElement = document.querySelector("#items")
        const errorElement = document.querySelector("#error")
        const emptyMessageElement = document.querySelector("#empty-message")
        const updateElement = document.querySelector("#update")
        const messageElement = document.querySelector("#message")
        
        
        updateElement.addEventListener("click", updateRestriction)
        
        function updateRestriction(){
            const title = titleElement.value
            const description = descriptionElement.value
            const error = errorElement.value
            let items = itemsElement.value.split("\n").map( item => item.trim() ).filter( item => item != "" )
            items = [... new Set(items)]
            let emptyMessage = emptyMessageElement.value
            
            titleElement.style.disabled = true
            descriptionElement.style.disabled = true
            itemsElement.style.disabled = true
            errorElement.style.disabled = true
            emptyMessageElement.style.disabled = true
            updateElement.style.disabled = true
            
            messageElement.innerHTML = `<p>submitting...<\/p>`
            google.script.run
                .withSuccessHandler((message)=>{
                    messageElement.innerHTML = message
                    titleElement.style.disabled = false
                    descriptionElement.style.disabled = false
                    itemsElement.style.disabled = false
                    errorElement.style.disabled = false
                    emptyMessageElement.style.disabled = false
                    updateElement.style.disabled = false
                })
                .withFailureHandler(err => {
                    messageElement.innerHTML = `<p class="error">${err.message}<\/p>`
                    titleElement.style.disabled = false
                    descriptionElement.style.disabled = false
                    itemsElement.style.disabled = false
                    errorElement.style.disabled = false
                    emptyMessageElement.style.disabled = false
                    updateElement.style.disabled = false
                })
                .updateRestriction({title, description, error, items, emptyMessage})
        }
    </script>
  </body>
</html>


